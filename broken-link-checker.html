<!doctype html>
<html lang="da">
  <head>
    <!-- Fælles header/nav (burger + aktivt link) -->
    <script src="/assets/include-header.js?v=7" defer></script>

    <meta charset="utf-8" />
    <title>Broken Link Checker – find døde links (404, 500) | Seohub.dk</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description"
      content="Tjek en side eller en liste af URL’er for døde links (404/500), redirects og CORS-ukendte. Ingen login – kør direkte i browseren.">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="canonical" href="https://www.seohub.dk/broken-link-checker.html" />

    <!-- Cookie consent + GA (din eksisterende løsning) -->
    <script src="/assets/consent-analytics.js" defer></script>

    <!-- Tailwind (UI) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Article/Tool structured data (valgfrit) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Broken Link Checker",
      "applicationCategory": "SEO Tool",
      "operatingSystem": "Web",
      "url": "https://www.seohub.dk/broken-link-checker.html",
      "publisher": { "@type": "Organization", "name": "Seohub.dk" },
      "description": "Find døde links (404/500), se redirects og CORS-ukendte links. Kør direkte i browseren."
    }
    </script>
  </head>

  <body class="min-h-screen bg-gradient-to-b from-neutral-50 to-neutral-100 text-neutral-900">
    <!-- Hero -->
    <section class="py-10 md:py-14">
      <div class="max-w-6xl mx-auto px-4">
        <div class="rounded-2xl p-12 md:p-16 text-white shadow-lg"
             style="background:linear-gradient(135deg,#6366f1 0%,#3b82f6 50%,#06b6d4 100%)">
          <p class="text-xs uppercase tracking-wider text-blue-100/90 mb-2">SEO · Værktøj</p>
          <h1 class="text-4xl md:text-5xl font-extrabold mb-3 leading-tight">
            Broken Link Checker
          </h1>
          <p class="text-blue-100 text-lg md:text-xl max-w-3xl">
            Find døde links (404/500), se redirects og ukendte (CORS) – tjek en side eller indsæt en liste af URL’er.
          </p>
        </div>
      </div>
    </section>

    <!-- Værktøj -->
    <main class="max-w-6xl mx-auto px-4 pb-12">
      <section class="bg-white/70 backdrop-blur rounded-2xl shadow p-6 md:p-8 border border-neutral-100">
        <h2 class="text-2xl font-bold mb-1">Tjek links</h2>
        <p class="text-neutral-600 mb-6">Vælg en metode: crawl en side (finder links i HTML) eller indsæt URL’er manuelt (én pr. linje).</p>

        <!-- Tabs -->
        <div class="flex gap-2 text-sm mb-6" id="modeTabs">
          <button data-mode="page"
            class="tab-btn px-3 py-2 rounded-xl border bg-neutral-50 hover:bg-neutral-100 font-medium">Crawl en side</button>
          <button data-mode="list"
            class="tab-btn px-3 py-2 rounded-xl border bg-neutral-50 hover:bg-neutral-100">Indsæt liste</button>
        </div>

        <!-- Form: crawl side -->
        <div id="modePage" class="space-y-4">
          <label class="block">
            <span class="block text-sm font-medium mb-1">Side-URL (samme origin anbefales)</span>
            <input id="pageUrl" type="url" placeholder="https://www.seohub.dk/"
              class="w-full border rounded-xl p-3 focus:outline-none focus:ring focus:ring-indigo-200"
              value="https://www.seohub.dk/">
          </label>

          <div class="grid md:grid-cols-3 gap-3">
            <label class="block">
              <span class="block text-sm font-medium mb-1">Maks. links (fra siden)</span>
              <input id="maxLinks" type="number" min="1" max="2000" value="300"
                class="w-full border rounded-xl p-3 focus:outline-none focus:ring focus:ring-indigo-200">
            </label>
            <label class="block">
              <span class="block text-sm font-medium mb-1">Timeout pr. URL (ms)</span>
              <input id="timeoutMs" type="number" min="1000" max="30000" value="8000"
                class="w-full border rounded-xl p-3 focus:outline-none focus:ring focus:ring-indigo-200">
            </label>
            <label class="inline-flex items-center gap-2 mt-7">
              <input id="sameOnly" type="checkbox" class="rounded" checked>
              <span class="text-sm">Kun same-origin (anbefalet)</span>
            </label>
          </div>

          <div class="flex items-center gap-3 pt-2">
            <button id="btnCrawl"
              class="px-4 py-2 rounded-2xl text-white bg-blue-600 hover:bg-blue-700">Crawl & tjek</button>
            <button id="btnStop" class="px-4 py-2 rounded-2xl border hover:bg-neutral-50 hidden">Stop</button>
          </div>
        </div>

        <!-- Form: liste -->
        <div id="modeList" class="space-y-4 hidden">
          <label class="block">
            <span class="block text-sm font-medium mb-1">URL’er (én pr. linje)</span>
            <textarea id="urlList" rows="8" placeholder="https://www.seohub.dk/\nhttps://www.seohub.dk/blog/"
              class="w-full border rounded-xl p-3 focus:outline-none focus:ring focus:ring-indigo-200"></textarea>
          </label>

          <div class="grid md:grid-cols-3 gap-3">
            <label class="block">
              <span class="block text-sm font-medium mb-1">Timeout pr. URL (ms)</span>
              <input id="timeoutMsList" type="number" min="1000" max="30000" value="8000"
                class="w-full border rounded-xl p-3 focus:outline-none focus:ring focus:ring-indigo-200">
            </label>
            <label class="inline-flex items-center gap-2 mt-7">
              <input id="sameOnlyList" type="checkbox" class="rounded">
              <span class="text-sm">Kun same-origin</span>
            </label>
          </div>

          <div class="flex items-center gap-3 pt-2">
            <button id="btnCheckList"
              class="px-4 py-2 rounded-2xl text-white bg-blue-600 hover:bg-blue-700">Tjek liste</button>
            <button id="btnStopList" class="px-4 py-2 rounded-2xl border hover:bg-neutral-50 hidden">Stop</button>
          </div>
        </div>
      </section>

      <!-- Status + resultater -->
      <section class="bg-white/70 backdrop-blur rounded-2xl shadow p-6 md:p-8 border border-neutral-100 mt-6">
        <div class="flex items-center justify-between gap-4 mb-4">
          <h2 class="text-xl font-semibold">Resultater</h2>
          <div class="text-sm text-neutral-600">
            <span id="progressText">Ingen scanning i gang.</span>
          </div>
        </div>

        <div class="overflow-auto border rounded-2xl">
          <table class="min-w-full text-sm">
            <thead class="bg-neutral-50">
              <tr>
                <th class="text-left px-3 py-2 border-b">URL</th>
                <th class="text-left px-3 py-2 border-b">Type</th>
                <th class="text-left px-3 py-2 border-b">Status</th>
                <th class="text-left px-3 py-2 border-b">Endelig URL</th>
                <th class="text-left px-3 py-2 border-b">Note</th>
              </tr>
            </thead>
            <tbody id="resultBody"></tbody>
          </table>
        </div>

        <div class="flex flex-wrap gap-2 mt-4">
          <button id="btnExportCsv" class="px-3 py-2 rounded-xl text-sm border bg-neutral-50 hover:bg-neutral-100">
            Download CSV
          </button>
          <button id="btnExportJson" class="px-3 py-2 rounded-xl text-sm border bg-neutral-50 hover:bg-neutral-100">
            Download JSON
          </button>
          <button id="btnShowErrors" class="px-3 py-2 rounded-xl text-sm border bg-neutral-50 hover:bg-neutral-100">
            Vis kun fejl (toggle)
          </button>
        </div>

        <p class="text-xs text-neutral-500 mt-4">
          Bemærk: Eksterne domæner kan returnere <em>CORS/ukendt</em>, fordi browseren ikke må læse status uden CORS-tilladelse. Same-origin (fx seohub.dk) fungerer bedst.
        </p>
      </section>

      <!-- CTA: DanDomain -->
      <section class="mt-8">
        <div class="rounded-2xl p-6 md:p-8 text-white shadow-lg"
             style="background:linear-gradient(135deg,#0ea5e9 0%,#6366f1 60%,#8b5cf6 100%)">
          <div class="text-[11px] uppercase tracking-wide mb-2 opacity-90">Sponsoreret anbefaling</div>
          <h3 class="text-2xl font-extrabold mb-2">Klar til at få dit domæne online?</h3>
          <p class="text-blue-100 mb-3">
            DanDomain – domæner & hosting til virksomheder i alle størrelser.
          </p>
          <a href="https://go.adt256.com/t/t?a=1715455208&as=1999446175&t=2&tk=1"
             target="_blank" rel="sponsored noopener nofollow"
             class="inline-flex items-center gap-2 bg-white text-neutral-900 px-4 py-2 rounded-xl font-semibold hover:shadow-lg transition">
            Besøg DanDomain
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                 class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round">
              <path d="M7 17L17 7" /><path d="M7 7h10v10" />
            </svg>
          </a>
        </div>
      </section>
    </main>

    <!-- Footer (fælles) -->
    <script src="/assets/include-footer.js?v=2" defer></script>

    <!-- App script -->
    <script>
    (function(){
      const $modePage   = document.getElementById('modePage');
      const $modeList   = document.getElementById('modeList');
      const $tabs       = document.querySelectorAll('#modeTabs .tab-btn');
      let mode = 'page';

      function setMode(m){
        mode = m;
        $tabs.forEach(btn=>{
          const active = btn.getAttribute('data-mode') === m;
          btn.classList.toggle('font-medium', active);
          btn.classList.toggle('bg-neutral-50', !active);
          btn.classList.toggle('bg-neutral-100', active);
          btn.classList.toggle('border-blue-200', active);
        });
        $modePage.classList.toggle('hidden', m !== 'page');
        $modeList.classList.toggle('hidden', m !== 'list');
      }
      $tabs.forEach(btn=> btn.addEventListener('click', ()=> setMode(btn.getAttribute('data-mode')) ));
      setMode('page');

      // UI refs
      const $pageUrl   = document.getElementById('pageUrl');
      const $maxLinks  = document.getElementById('maxLinks');
      const $timeoutMs = document.getElementById('timeoutMs');
      const $sameOnly  = document.getElementById('sameOnly');

      const $btnCrawl  = document.getElementById('btnCrawl');
      const $btnStop   = document.getElementById('btnStop');

      const $urlList   = document.getElementById('urlList');
      const $timeoutMsList = document.getElementById('timeoutMsList');
      const $sameOnlyList  = document.getElementById('sameOnlyList');
      const $btnCheckList  = document.getElementById('btnCheckList');
      const $btnStopList   = document.getElementById('btnStopList');

      const $progress  = document.getElementById('progressText');
      const $tbody     = document.getElementById('resultBody');
      const $exportCsv = document.getElementById('btnExportCsv');
      const $exportJson= document.getElementById('btnExportJson');
      const $showErrors= document.getElementById('btnShowErrors');

      let stopFlag = false;
      let onlyErrors = false;
      let RESULTS = [];

      function originOf(u){
        try { return new URL(u, location.origin).origin; } catch(e){ return ""; }
      }
      function sameOrigin(u){
        return originOf(u) === location.origin;
      }
      function dedupe(arr){
        const seen = new Set(); const out = [];
        arr.forEach(x=>{ if (!seen.has(x)) { seen.add(x); out.push(x); } });
        return out;
      }
      function rowHTML(r){
        const cls = (r.status >= 200 && r.status < 400) ? 'text-green-700'
                 : (r.status >= 400 && r.status < 600) ? 'text-red-700'
                 : 'text-amber-700';
        const type = r.type || (sameOrigin(r.url) ? 'intern' : 'ekstern');
        const note = r.note || '';
        return `
          <tr class="align-top">
            <td class="px-3 py-2 border-b break-words">
              <a class="text-blue-600 hover:underline" href="${r.url}" target="_blank" rel="noopener">${r.url}</a>
            </td>
            <td class="px-3 py-2 border-b">${type}</td>
            <td class="px-3 py-2 border-b ${cls}">${r.statusText || r.status || 'ukendt'}</td>
            <td class="px-3 py-2 border-b break-words">${r.finalUrl ? `<a class="text-blue-600 hover:underline" href="${r.finalUrl}" target="_blank" rel="noopener">${r.finalUrl}</a>` : ''}</td>
            <td class="px-3 py-2 border-b">${note}</td>
          </tr>
        `;
      }
      function render(){
        const list = onlyErrors
          ? RESULTS.filter(r => !r.status || r.status >= 400)
          : RESULTS;
        $tbody.innerHTML = list.map(rowHTML).join('') || `
          <tr><td colspan="5" class="px-3 py-6 text-center text-neutral-500">Ingen resultater endnu.</td></tr>
        `;
      }
      $showErrors.addEventListener('click', ()=>{ onlyErrors = !onlyErrors; render(); });

      function download(filename, content, type="text/plain;charset=utf-8"){
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.click();
        URL.revokeObjectURL(url);
      }
      $exportCsv.addEventListener('click', ()=>{
        const header = ["url","type","status","statusText","finalUrl","note"];
        const rows = RESULTS.map(r => [
          r.url,
          r.type || (sameOrigin(r.url) ? "intern" : "ekstern"),
          r.status ?? "",
          r.statusText ?? "",
          r.finalUrl ?? "",
          (r.note || "").replace(/\n/g," ")
        ]);
        const csv = [header, ...rows].map(row => row.map(v=>{
          const s = String(v ?? "");
          return /[",\n;]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
        }).join(";")).join("\n");
        download("broken-links.csv", csv, "text/csv;charset=utf-8");
      });
      $exportJson.addEventListener('click', ()=>{
        download("broken-links.json", JSON.stringify(RESULTS, null, 2), "application/json");
      });

      async function fetchWithTimeout(url, ms){
        const ctrl = new AbortController();
        const timer = setTimeout(()=>ctrl.abort(), ms);
        try {
          const res = await fetch(url, { redirect:'follow', signal: ctrl.signal });
          clearTimeout(timer);
          return res;
        } catch (e) {
          clearTimeout(timer);
          throw e;
        }
      }

      async function checkOne(url, ms){
        // Returner en result-record
        const rec = { url, finalUrl:"", status:null, statusText:"", note:"" };
        try {
          const res = await fetchWithTimeout(url, ms);
          // CORS: hvis opaque, må vi ikke læse status -> status=0
          if (res.type === "opaque") {
            rec.status = null;
            rec.statusText = "CORS/ukendt";
            rec.note = "Kan ikke læse status pga. CORS";
            return rec;
          }
          rec.status = res.status;
          rec.statusText = String(res.status);
          // endelig URL (redirect follow)
          try { rec.finalUrl = res.url || ""; } catch(_) {}
          return rec;
        } catch(e){
          rec.status = null;
          rec.statusText = "netværksfejl/timeout";
          rec.note = (e && e.name === "AbortError") ? "Timeout" : "Netværksfejl eller blokeret";
          return rec;
        }
      }

      function extractLinksFromHtml(html, baseUrl){
        const doc = new DOMParser().parseFromString(html, "text/html");
        const as = Array.from(doc.querySelectorAll("a[href]"));
        const urls = as.map(a => {
          try { return new URL(a.getAttribute("href"), baseUrl).href; }
          catch(e){ return null; }
        }).filter(Boolean);
        // filtrér fragmenter/mailto/tel/javascript
        return dedupe(urls.filter(u => !u.startsWith("mailto:") && !u.startsWith("tel:") && !u.startsWith("javascript:") && !u.startsWith("data:")));
      }

      async function crawlAndCheck(pageUrl, limit, ms, sameOnlyFlag){
        RESULTS = []; render();
        stopFlag = false; $btnStop.classList.remove('hidden'); $btnCrawl.classList.add('opacity-50','pointer-events-none');

        $progress.textContent = "Henter side…";
        let html = "";
        try {
          // kun same-origin må læse HTML uden CORS
          if (!sameOrigin(pageUrl)) {
            $progress.textContent = "Kan ikke hente HTML (CORS). Brug 'Indsæt liste' eller slå same-origin fra ved manuel liste.";
            $btnStop.classList.add('hidden'); $btnCrawl.classList.remove('opacity-50','pointer-events-none');
            return;
          }
          const r = await fetch(pageUrl, { redirect:'follow' });
          html = await r.text();
        } catch(e){
          $progress.textContent = "Kunne ikke hente siden.";
          $btnStop.classList.add('hidden'); $btnCrawl.classList.remove('opacity-50','pointer-events-none');
          return;
        }

        let links = extractLinksFromHtml(html, pageUrl);
        if (sameOnlyFlag) links = links.filter(u => sameOrigin(u));
        if (limit && limit > 0) links = links.slice(0, limit);

        let done = 0, total = links.length;
        if (!total) {
          $progress.textContent = "Ingen links fundet (efter filtre).";
          $btnStop.classList.add('hidden'); $btnCrawl.classList.remove('opacity-50','pointer-events-none');
          return;
        }

        for (const u of links) {
          if (stopFlag) break;
          $progress.textContent = `Tjekker ${++done}/${total}…`;
          const rec = await checkOne(u, ms);
          rec.type = sameOrigin(u) ? "intern" : "ekstern";
          RESULTS.push(rec);
          if (done % 5 === 0) render();
        }
        render();
        $progress.textContent = stopFlag ? "Stoppet." : "Færdig.";
        $btnStop.classList.add('hidden'); $btnCrawl.classList.remove('opacity-50','pointer-events-none');
        stopFlag = false;
      }

      async function checkList(urls, ms, sameOnlyFlag){
        RESULTS = []; render();
        stopFlag = false; $btnStopList.classList.remove('hidden'); $btnCheckList.classList.add('opacity-50','pointer-events-none');

        urls = urls.map(u=>{
          try { return new URL(u, location.origin).href; } catch(e){ return null; }
        }).filter(Boolean);
        if (sameOnlyFlag) urls = urls.filter(u => sameOrigin(u));

        let done = 0, total = urls.length;
        if (!total){
          $progress.textContent = "Ingen gyldige URL’er i listen (efter filtre).";
          $btnStopList.classList.add('hidden'); $btnCheckList.classList.remove('opacity-50','pointer-events-none');
          return;
        }

        for (const u of urls){
          if (stopFlag) break;
          $progress.textContent = `Tjekker ${++done}/${total}…`;
          const rec = await checkOne(u, ms);
          rec.type = sameOrigin(u) ? "intern" : "ekstern";
          RESULTS.push(rec);
          if (done % 5 === 0) render();
        }
        render();
        $progress.textContent = stopFlag ? "Stoppet." : "Færdig.";
        $btnStopList.classList.add('hidden'); $btnCheckList.classList.remove('opacity-50','pointer-events-none');
        stopFlag = false;
      }

      // Handlers
      $btnCrawl.addEventListener('click', ()=>{
        const url = $pageUrl.value.trim();
        const limit = Math.max(1, parseInt($maxLinks.value || "300", 10));
        const ms = Math.max(1000, parseInt($timeoutMs.value || "8000", 10));
        const sameOnlyFlag = !!$sameOnly.checked;
        crawlAndCheck(url, limit, ms, sameOnlyFlag);
      });
      $btnStop.addEventListener('click', ()=>{ stopFlag = true; });

      $btnCheckList.addEventListener('click', ()=>{
        const list = $urlList.value.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
        const ms = Math.max(1000, parseInt($timeoutMsList.value || "8000", 10));
        const sameOnlyFlag = !!$sameOnlyList.checked;
        checkList(list, ms, sameOnlyFlag);
      });
      $btnStopList.addEventListener('click', ()=>{ stopFlag = true; });
    })();
    </script>
  </body>
</html>
