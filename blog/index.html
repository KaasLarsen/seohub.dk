<script>
  (async function () {
    const el = document.getElementById('posts');

    function show(msg) {
      el.innerHTML = '<p class="text-sm text-neutral-600">' + msg + '</p>';
    }

    try {
      // Bypass cache og vær tolerant ift. placering
      const res = await fetch('/blog/posts.json?ts=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) {
        console.error('HTTP status:', res.status, res.statusText);
        show('Kunne ikke indlæse indlæg (HTTP ' + res.status + ').');
        return;
      }

      // Sikr at response faktisk er JSON og ikke HTML via en forkert rewrite
      const ct = res.headers.get('content-type') || '';
      const text = await res.text();
      if (!ct.includes('application/json')) {
        console.warn('Forventede JSON, men fik:', ct, text.slice(0, 120) + '...');
        // prøv at parse alligevel – nogle hosts sætter forkert content-type
      }

      let items;
      try {
        items = JSON.parse(text);
      } catch (e) {
        console.error('JSON parse-fejl:', e, text);
        show('Indlæste filen, men den var ikke gyldig JSON.');
        return;
      }

      if (!Array.isArray(items)) {
        console.error('Forventede array, fik:', items);
        show('Formatet i posts.json er ikke som forventet.');
        return;
      }
      if (items.length === 0) {
        show('Ingen indlæg endnu.');
        return;
      }

      // sortér nyest først (ISO-datoer)
      items.sort((a,b) => (a.date < b.date ? 1 : -1));

      // render
      el.innerHTML = '';
      for (const p of items) {
        const slug = (p.slug || '').trim();
        const title = p.title || 'Uden titel';
        const date = p.date ? new Date(p.date).toLocaleDateString('da-DK') : '';
        const excerpt = p.excerpt || '';
        const tags = (p.tags || []).map(t =>
          `<span class="text-xs bg-neutral-100 border px-2 py-1 rounded-full">${t}</span>`
        ).join(' ');
        const url = `/blog/${slug}.html`;

        el.insertAdjacentHTML('beforeend', `
          <article class="rounded-2xl border p-5 bg-white hover:shadow transition">
            <h3 class="text-lg font-semibold">
              <a class="hover:underline" href="${url}">${title}</a>
            </h3>
            <p class="text-xs text-neutral-500 mt-1">${date}</p>
            <p class="text-sm text-neutral-700 mt-3">${excerpt}</p>
            <div class="flex gap-2 mt-3">${tags}</div>
            <a class="inline-block mt-4 text-blue-600 hover:underline" href="${url}">Læs mere →</a>
          </article>
        `);
      }
    } catch (e) {
      console.error(e);
      show('Kunne ikke indlæse indlæg lige nu.');
    }
  })();
</script>
